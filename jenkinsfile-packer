pipeline {
    agent any 

 environment {
        
        AWS_SECRET_ACCESS_KEY = credentials ('aws-secret-access-key')
        AWS_ACCESS_KEY_ID = credentials ('aws-access-key-id')
        AWS_DEFAULT_REGION = 'us-east-2'
    }

stages {
        stage ('checkout') {
            steps {
                checkout scm
            }
        }
        stage('packer init') {
            steps {
            dir('packer') {
                sh 'packer init aws-nginx-git-java.pkr.hcl'
            }
        }
    }

        stage ('packer validate .') {
            steps {
                dir ('packer') {
                    sh ' packer validate .'
                }
            }
        } 

       stage('Packer Build') {
    steps {
        dir('packer') {
            sh 'packer build .'

            // extract AMI ID from manifest.json
            script {
                AMI_ID = sh(
                    script: "jq -r '.builds[0].artifact_id | split(\":\")[1]' manifest.json",
                    returnStdout: true
                ).trim()

                echo "Created AMI ID: ${AMI_ID}"
            }
        }
    }
}

