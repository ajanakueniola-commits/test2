pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'us-east-2'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Packer Init') {
            steps {
                dir('packer') {
                    sh 'packer init aws-nginx-git-java.pkr.hcl'
                }
            }
        }

        stage('Packer Validate') {
            steps {
                dir('packer') {
                    sh 'packer validate .'
                }
            }
        }

        stage('Packer Build') {
            steps {
                withCredentials([
                    [$class: 'AmazonWebServicesCredentialsBinding',
                     credentialsId: 'aws-credentials']
                ]) {
                    dir('packer') {
                        sh 'packer build .'

                        script {
                            def AMI_ID = sh(
                                script: "jq -r '.builds[0].artifact_id | split(\":\")[1]' manifest.json",
                                returnStdout: true
                            ).trim()

                            echo "Created AMI ID: ${AMI_ID}"
                        }
                    }
                }
            }
        }
    }
}
